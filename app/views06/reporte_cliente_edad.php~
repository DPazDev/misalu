<?php

/* Nombre del Archivo: reporte_cliente_edad.php
   Descripci칩n: Realiza la busqueda en la base de datos, para Reporte de Impresi칩n: Relaci칩n de Clientes entre A y B a침os, de un Ente en Particular.
*/ 

   include ("../../lib/jfunciones.php");
   sesion();

 list($ente)=explode("@",$_REQUEST['ente']);

	if($ente==0){	        $condicion_ente="";
}
	else if($ente=="-01"){
	$condicion_ente="and entes.id_tipo_ente=1";
}
	else if($ente=="-02"){
	$condicion_ente="and entes.id_tipo_ente=2";
}
	else if($ente=="-03"){
	$condicion_ente="and entes.id_tipo_ente=3";
}
	else if($ente=="-04"){
	$condicion_ente="and entes.id_tipo_ente=4";
}
	else if($ente=="-05"){
	$condicion_ente="and entes.id_tipo_ente=5";
}
	else{
	$condicion_ente="and titulares.id_ente=$ente";
	}


  list($estado)=explode("@",$_REQUEST['estado']);
	if($estado==0)	        $condicion_estado="";
	else
   $condicion_estado="and estados_t_b.id_estado_cliente=$estado";


   $inicio=$_REQUEST['inicio'];
   $fin=$_REQUEST['fin'];
   $tipcliente=$_REQUEST['tipcliente'];


$q_titular=("select clientes.apellidos,clientes.nombres,clientes.cedula,clientes.fecha_nacimiento,
titulares.id_titular,titulares.id_cliente,estados_clientes.estado_cliente,entes.id_tipo_ente, estados_t_b.id_estado_cliente,entes.nombre from entes,clientes,titulares,estados_t_b,estados_clientes  where clientes.id_cliente=titulares.id_cliente  $condicion_ente and titulares.id_ente=entes.id_ente and  estados_t_b.id_titular=titulares.id_titular $condicion_estado and estados_t_b.id_estado_cliente=estados_clientes.id_estado_cliente and estados_t_b.id_beneficiario='0' group by clientes.apellidos,clientes.nombres,clientes.cedula,clientes.fecha_nacimiento,
titulares.id_titular,titulares.id_cliente,estados_clientes.estado_cliente,estados_t_b.id_estado_cliente,entes.nombre,entes.id_tipo_ente order by estados_clientes.estado_cliente,entes.nombre,clientes.fecha_nacimiento");
$r_titular=ejecutar($q_titular);


$q_beneficiario=("select clientes.apellidos,clientes.nombres,clientes.cedula,clientes.fecha_nacimiento,parentesco.parentesco,beneficiarios.id_titular,beneficiarios.id_beneficiario,estados_clientes.estado_cliente,entes.id_tipo_ente, estados_t_b.id_estado_cliente,entes.nombre from  entes,clientes,parentesco,beneficiarios,estados_t_b,estados_clientes,titulares where clientes.id_cliente=beneficiarios.id_cliente and beneficiarios.id_titular=titulares.id_titular and titulares.id_ente=entes.id_ente $condicion_ente and beneficiarios.id_parentesco=parentesco.id_parentesco and estados_t_b.id_beneficiario=beneficiarios.id_beneficiario $condicion_estado and estados_t_b.id_estado_cliente=estados_clientes.id_estado_cliente order by estados_clientes.estado_cliente,entes.nombre,clientes.fecha_nacimiento,parentesco.parentesco");
$r_beneficiario=ejecutar($q_beneficiario);

$qente=("select nombre from entes where entes.id_ente=$ente");
$rente=ejecutar($qente);
$fente=asignar_a($rente);

$q_estado=("select estados_clientes.estado_cliente from estados_clientes where estados_clientes.id_estado_cliente=$estado");
$r_estado=ejecutar($q_estado);
$f_estado=asignar_a($r_estado);

?>

<table class="tabla_citas"  cellpadding=0 cellspacing=0> 
	<tr>
		<td class="titulo_seccion" colspan="4">Reporte Relaci&oacute;n 
<?php if($tipcliente=='TITULARES') echo "Clientes "."TITULARES"  ;
      else if($tipcliente=='BENEFICIARIOS') echo "Clientes "."BENEFICIARIOS";
      else echo "TODOS LOS CLIENTES";?> entre <?php echo "$inicio y $fin";?> a&ntilde;os,  <?
if($estado==0)	echo "Todos los Estados, "; else echo "en Estado "."$f_estado[estado_cliente], ";
if($ente=="0")echo "TODOS LOS ENTES";
else if($ente=="-01") echo "NATURALES";
else if($ente=="-02") echo "JURIDICOS";
else if($ente=="-03") echo "GUBERNAMENTALES";
else if($ente=="-04") echo "PRIVADOS";
else if($ente=="-05") echo "SINDICATOS"; 
else echo "del Ente "."$fente[nombre]";?> </td>     
	</tr>
</table>	
 <br>

<table class="tabla_citas"  cellpadding=0 cellspacing=0 rules="rows"> 


	
<?php 
	if($tipcliente=='TITULARES' or $tipcliente=='BENEFICIARIOS' or $tipcliente=='TODOS LOS CLIENTES'){?>
<tr> 
		<td class="tdcampos">CLIENTE</td>   
		<td class="tdcampos">NOMBRES</td>     
		<td class="tdcampos">APELLIDOS</td> 
		<td class="tdcampos">CEDULA</td>  
		<td class="tdcampos">ESTADO</td> 
		<td class="tdcampos">FECHA DE NACIMIENTO</td> 
		<td class="tdcampos">EDAD</td> 
		<td class="tdcampos">ENTE</td>             
 	<?if($tipcliente=='BENEFICIARIOS' or $tipcliente=='TODOS LOS CLIENTES'){?> 
		<td class="tdcampos">PARENTESCO</td>       
		      
	</tr>
	<?php }}               
		
	     $t=0;$b=0;
		 
	     while($f_titular=asignar_a($r_titular,NULL,PGSQL_ASSOC))
		{

if (calcular_edad($f_titular['fecha_nacimiento'])>=$inicio &&  calcular_edad($f_titular['fecha_nacimiento'])<=$fin) { 
	
if($tipcliente=='TITULARES' or $tipcliente=='TODOS LOS CLIENTES'){
	  echo"
            <tr> 

		    <td class=\"tdtituloss\">$f_titular[id_titular]</td>   
	            <td class=\"tdtituloss\">$f_titular[nombres]</td>  
	            <td class=\"tdtituloss\">$f_titular[apellidos]</td>      
	            <td class=\"tdtituloss\">$f_titular[cedula]</td>   
	            <td class=\"tdcamposr\">$f_titular[estado_cliente]</td>
	            <td class=\"tdtituloss\">$f_titular[fecha_nacimiento]</td>
	            <td class=\"tdtituloss\">";?><?php echo calcular_edad($f_titular['fecha_nacimiento']);
	    echo"   <td class=\"tdtituloss\">$f_titular[nombre]</td>"; ?>
			</td>       
	                 
	        </tr>
<?php

	$t++;}
		}
		}


	     while($f_beneficiario=asignar_a($r_beneficiario,NULL,PGSQL_ASSOC))
		{

if (calcular_edad($f_beneficiario['fecha_nacimiento'])>=$inicio &&  calcular_edad($f_beneficiario['fecha_nacimiento'])<=$fin) { 
if($tipcliente=='BENEFICIARIOS' && $f_beneficiario['id_beneficiario']>0 or $tipcliente=='TODOS LOS CLIENTES' or $f_titular['id_titular']>0){	
	  echo"
            <tr> 

		    <td class=\"tdtituloss\">$f_beneficiario[id_beneficiario]  </td>   
	            <td class=\"tdtituloss\">$f_beneficiario[nombres] </td>  
	            <td class=\"tdtituloss\">$f_beneficiario[apellidos] </td>      
	            <td class=\"tdtituloss\">$f_beneficiario[cedula] </td>   
	            <td class=\"tdcamposr\">$f_beneficiario[estado_cliente] </td>
	            <td class=\"tdtituloss\">$f_beneficiario[fecha_nacimiento]  </td>
	            <td class=\"tdtituloss\">";?><?php echo calcular_edad($f_beneficiario['fecha_nacimiento'])
 ;?>
<?php 		    echo "<td class=\"tdtituloss\">$f_beneficiario[nombre]</td>
			<td class=\"tdtituloss\">$f_beneficiario[parentesco] </td> "; ?>
			</td>       
	                 
	        </tr>
<?php
		$b++;}
		}
		}
	?>

	<tr> <td colspan =9 >&nbsp;</td>
	</tr>
	<tr> <td>&nbsp;</td></tr>
	<tr>
	        <td colspan=9 class="tdcamposc" >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; HAY UN TOTAL DE <? if($tipcliente=='TITULARES') echo $t." $tipcliente"; 
	       else if($tipcliente=='BENEFICIARIOS') echo $b." $tipcliente"; 
               else echo $t+$b." CLIENTES, "."$t"." TITULARES"." Y "."$b"." BENEFICIARIOS"; ?> 
		</td>
	</tr>
</table>
<br>
	<tr>
	        <td colspan=9 class="tdcamposs" title="Imprimir reporte">
	<?php
		$url="'views06/ireporte_cliente_edad.php?ente=$ente&inicio=$inicio&fin=$fin&tipcliente=$tipcliente&estado=$estado'";
			?> <a href="javascript: imprimir(<?php echo $url; ?>);" class="boton">Imprimir</a> <?php
		$url="'views06/excel_cliente_edad.php?ente=$ente&inicio=$inicio&fin=$fin&tipcliente=$tipcliente&estado=$estado'";
			?> <a href="javascript: imprimir(<?php echo $url; ?>);" class="boton">Excel</a>
		</td>
	</tr> 
	<tr> <td>&nbsp;</td></tr>

</table>
	<tr> <td>&nbsp;</td></tr>

