<?php
/* Nombre del Archivo: reporte_estado_cliente.php
   Descripci贸n: Realiza la busqueda en la base de datos, para Reporte de Impresi贸n: Relaci贸n Estado de los Clientes, de un determinado Ente
*/  


 include ("../../lib/jfunciones.php");
   sesion();

   list($estado)=explode("@",$_REQUEST['estado']);
if($estado==0)	        $condicion_estado="";
	else
   $condicion_estado="	and estados_t_b.id_estado_cliente=$estado";

   $tipcliente=$_REQUEST['tipcliente'];

   list($ente)=explode("@",$_REQUEST['ente']);
	if($ente=="0"){	        $condicion_ente="";
}
	else if($ente=="-01"){
	$condicion_ente="and entes.id_tipo_ente=1";
}
	else if($ente=="-02"){
	$condicion_ente="and entes.id_tipo_ente=2";
}
	else if($ente=="-03"){
	$condicion_ente="and entes.id_tipo_ente=3";
}
	else if($ente=="-04"){
	$condicion_ente="and entes.id_tipo_ente=4";
}
	else if($ente=="-05"){
	$condicion_ente="and entes.id_tipo_ente=5";
}
	else{
	$condicion_ente="and titulares.id_ente=$ente";
	}

if($tipcliente=='TODOS LOS CLIENTES'){
	//se busca titulares y beneficiarios
	$tc="and estados_t_b.id_titular>0 and 
	     (estados_t_b.id_beneficiario>0 or estados_t_b.id_beneficiario=0) 
	     ";
}else if($tipcliente=='TITULARES'){
	//solo titulares
	$tc="and estados_t_b.id_titular>0 and 
	      estados_t_b.id_beneficiario=0";
}else if($tipcliente=='BENEFICIARIOS'){
	//solo beneficiarios
	$tc="and estados_t_b.id_titular>0 and 
	      estados_t_b.id_beneficiario>0";
}

$q_reporte=("select
estados_t_b.id_estado_cliente,
estados_t_b.id_titular,
estados_t_b.id_beneficiario,
estados_clientes.estado_cliente,
titulares.id_ente,entes.id_tipo_ente, entes.nombre

from estados_t_b,estados_clientes,entes,titulares
where estados_t_b.id_titular=titulares.id_titular and
estados_clientes.id_estado_cliente=estados_t_b.id_estado_cliente
$condicion_estado
$tc
$condicion_ente and titulares.id_ente=entes.id_ente


ORDER BY estados_clientes.estado_cliente,entes.nombre asc");
$r_reporte=ejecutar($q_reporte);

$q_estado=("select estados_clientes.estado_cliente from estados_clientes where estados_clientes.id_estado_cliente=$estado");
$r_estado=ejecutar($q_estado);
$f_estado=asignar_a($r_estado);


$q_ente=("select entes.nombre from entes where id_ente=$ente");
$r_ente=ejecutar($q_ente);
$f_ente=asignar_a($r_ente);


?>

<table class="tabla_citas"  cellpadding=0 cellspacing=0> 
	<tr>
		<td class="titulo_seccion" colspan="11">Reporte Relaci贸n de <?php echo "$tipcliente";?>, <?php 
if('$estado'=="0") echo "Todos los Estados"; else echo "en Estado "."$f_estado[estado_cliente]";?>, <?
if($ente=="0") echo "TODOS LOS ENTES";
if($ente=="-01") echo "NATURALES";
else if($ente=="-02") echo "JURIDICOS";
else if($ente=="-03") echo "GUBERNAMENTALES";
else if($ente=="-04") echo "PRIVADOS";
else if($ente=="-05") echo "SINDICATOS"; 
else echo "del Ente "."$f_ente[nombre] ";?> </td>     
        </tr>
</table>
	
 <br>

<table class="tabla_citas"  cellpadding=0 cellspacing=0 rules="rows"> 
	
	<tr> 
	   	<td class="tdcampos">CLIENTE</td>   
	   
<?php 
	if($tipcliente=='TITULARES'){?>
	
		<td class="tdcampos">&nbsp;TITULAR</td>
	        <td class="tdcampos">CEDULA TITULAR</td> 
		<td class="tdcampos">ESTADO</td>
		<td class="tdcampos">&nbsp;COMENTARIOS</td>        
		<td class="tdcampos">ENTE</td>        
		     
	</tr>

<?php } if($tipcliente=='BENEFICIARIOS' or $tipcliente=='TODOS LOS CLIENTES') { ?>
		<td class="tdcampos">&nbsp;TITULAR</td>
	        <td class="tdcampos">CEDULA TITULAR</td>
		<td class="tdcampos">&nbsp;BENEFICIARIO</td>
	        <td class="tdcampos">CEDULA BENEFICIARIO</td>
		<td class="tdcampos">&nbsp;ESTADO</td> 
		<td class="tdcampos">&nbsp;COMENTARIOS</td> 
		<td class="tdcampos">ENTE</td>        
		      
	</tr>
 
<?php } 
	     $t=0;$b=0;$t1=0;
		  $bsf=0; 

	     while($f_reporte=asignar_a($r_reporte,NULL,PGSQL_ASSOC))
		{

			$rtitular=("select clientes.id_cliente,clientes.nombres,clientes.apellidos,clientes.cedula,clientes.comentarios from clientes,titulares where titulares.id_titular=$f_reporte[id_titular] and titulares.id_cliente=clientes.id_cliente"); 
			$qtitular=ejecutar($rtitular);
			$ftitular=asignar_a($qtitular);

			   
				if ($f_reporte['id_beneficiario']>0){
				  $rbenf=("select clientes.id_cliente,clientes.nombres,clientes.apellidos,clientes.cedula,clientes.comentarios from clientes,beneficiarios where beneficiarios.id_beneficiario=$f_reporte[id_beneficiario] and beneficiarios.id_cliente=clientes.id_cliente;");
				

				  $qbenf=ejecutar($rbenf);
				  $fbenf=asignar_a($qbenf);
				  
			  }else{$fbenf='';}
  

$qentes=("select entes.nombre from entes where entes.id_ente=$ente");
$rentes=ejecutar($qentes);
$dataentes=asignar_a($rentes);
$fentes="$dataentes[nombre]";

$qestado=("select estados_clientes.estado_cliente from estados_clientes where estados_clientes.id_estado_cliente=$estado");
$restado=ejecutar($qestado);
$dataestado=asignar_a($restado);
$festado="$dataestado[estado_cliente]";

	 
	if($tipcliente=='TITULARES' && $f_reporte['id_beneficiario'==0]){
 echo"
		<tr> 
	        
		<td class=\"tdtituloss\">$ftitular[id_cliente]</td>
		<td class=\"tdtituloss\">$ftitular[nombres] $ftitular[apellidos]</td>   
		<td class=\"tdtituloss\">$ftitular[cedula]</td>
		<td class=\"tdcamposr\">$f_reporte[estado_cliente]</td>
		<td class=\"tdtituloss\">$ftitular[comentarios]</td>
		<td class=\"tdtituloss\">$f_reporte[nombre]</td>

	              
	        </tr>";
$t++;

} 
 
	if($tipcliente=='BENEFICIARIOS' && $f_reporte['id_beneficiario']>0 or $tipcliente=='TODOS LOS CLIENTES'){?>
		<tr> 
	          
		<td class="tdtituloss"> <?php if ($f_reporte['id_beneficiario']>0) echo "$fbenf[id_cliente]"; else echo "$ftitular[id_cliente]";?> </td>


<?php if($f_reporte['id_beneficiario']==0) $t1++;
if ($f_reporte['id_beneficiario']>0) $b++;
echo"
		<td class=\"tdtituloss\">$ftitular[nombres] $ftitular[apellidos]</td>   
		<td class=\"tdtituloss\">$ftitular[cedula]</td>
	        <td class=\"tdtituloss\">$fbenf[nombres] $fbenf[apellidos]</td> 
		<td class=\"tdtituloss\">$fbenf[cedula]</td> 
		<td class=\"tdcamposr\">$f_reporte[estado_cliente]</td>
		<td class=\"tdtituloss\">$ftitular[comentarios]</td>
		<td class=\"tdtituloss\">$f_reporte[nombre]</td>   
	        </tr>";
}} ?>  
	<tr>
		<td colspan=8>&nbsp; </td>
	</tr>
	<tr>
	        <td colspan=8 class="tdcampos"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;( Hay un total de <? if($tipcliente=='TITULARES') echo $t." $tipcliente"; 
	       else if($tipcliente=='BENEFICIARIOS') echo $b." $tipcliente"; 
               else echo $t1+$b." CLIENTES, "."$t1"." TITULARES"." y "."$b"." BENEFICIARIOS";?> ) </td>	       
	</tr>
</table>
  
<table>

<tr> <td>&nbsp; </td></tr>
	<tr>
	        <td colspan=9 class="tdcamposs" title="Imprimir reporte">
	<?php
		$url="'views06/ireporte_estado_cliente.php?ente=$ente&estado=$estado&tipcliente=$tipcliente'";
			?> <a href="javascript: imprimir(<?php echo $url; ?>);" class="boton">Imprimir</a>
	<?php
		$url="'views06/excel_estado_cliente.php?ente=$ente&estado=$estado&tipcliente=$tipcliente'";
			?> <a href="javascript: imprimir(<?php echo $url; ?>);" class="boton">Excel</a>
		</td>
	</tr> 
<tr> <td>&nbsp; </td></tr>
</table>
