<?
include ("../../lib/jfunciones.php");
sesion();
header('Content-type: application/vnd.ms-excel');//poner cabezera de excel
$numealeatorio=rand(2,99);//crea un numero aleatorio para el nombre del archivo
header("Content-Disposition: attachment; filename=archivo$numealeatorio.xls");//Esta ya es la hoja excel con el numero aleatorio.xls
header("Pragma: no-cache");//Para que no utili la cahce
header("Expires: 0");

/* Nombre del Archivo: excel_cliente_edad.php
   Descripci칩n: Realiza el Reporte de Impresi칩n en excel con los datos seleccionados: Relaci칩n de Clientes entre A y B a침os, de un Ente en Particular.
*/ 

  
  list($ente)=explode("@",$_REQUEST['ente']);

	if($ente==0){	        $condicion_ente="";
}
	else
	if($ente=="-01"){
	$condicion_ente="and entes.id_tipo_ente=1";
}
	else
	if($ente=="-02"){
	$condicion_ente="and entes.id_tipo_ente=2";
}
	else
	if($ente=="-03"){
	$condicion_ente="and entes.id_tipo_ente=3";
}
	else
	if($ente=="-04"){
	$condicion_ente="and entes.id_tipo_ente=4";
}
	else
	if($ente=="-05"){
	$condicion_ente="and entes.id_tipo_ente=5";
}
	else{
	$condicion_ente="and titulares.id_ente=$ente";
	}


  list($estado)=explode("@",$_REQUEST['estado']);
	if($estado==0)	        $condicion_estado="";
	else
   $condicion_estado="and estados_t_b.id_estado_cliente=$estado";
   $inicio=$_REQUEST['inicio'];
   $fin=$_REQUEST['fin'];
   $tipcliente=$_REQUEST['tipcliente'];


$q_titular=("select clientes.apellidos,clientes.nombres,clientes.cedula,clientes.fecha_nacimiento,
titulares.id_titular,titulares.id_cliente,estados_clientes.estado_cliente,entes.id_tipo_ente, estados_t_b.id_estado_cliente,entes.nombre from entes,clientes,titulares,estados_t_b,estados_clientes,estados_clientes  where clientes.id_cliente=titulares.id_cliente  $condicion_ente and titulares.id_ente=entes.id_ente and  estados_t_b.id_titular=titulares.id_titular $condicion_estado and estados_t_b.id_estado_cliente=estados_clientes.id_estado_cliente and estados_t_b.id_beneficiario='0' group by clientes.apellidos,clientes.nombres,clientes.cedula,clientes.fecha_nacimiento,
titulares.id_titular,titulares.id_cliente,estados_clientes.estado_cliente,estados_t_b.id_estado_cliente,entes.nombre,entes.id_tipo_ente order by estados_clientes.estado_cliente,entes.nombre,clientes.fecha_nacimiento");
$r_titular=ejecutar($q_titular);


$q_beneficiario=("select clientes.apellidos,clientes.nombres,clientes.cedula,clientes.fecha_nacimiento,parentesco.parentesco,beneficiarios.id_titular,beneficiarios.id_beneficiario,estados_clientes.estado_cliente,entes.id_tipo_ente, estados_t_b.id_estado_cliente,entes.nombre from entes,clientes,parentesco,beneficiarios,estados_t_b where clientes.id_cliente=beneficiarios.id_cliente and beneficiarios.id_titular=titulares.id_titular and titulares.id_ente=entes.id_ente $condicion_ente and beneficiarios.id_parentesco=parentesco.id_parentesco and estados_t_b.id_beneficiario=beneficiarios.id_beneficiario $condicion_estado and estados_t_b.id_estado_cliente=estados_clientes.id_estado_cliente order by estados_clientes.estado_cliente,entes.nombre,clientes.fecha_nacimiento,parentesco.parentesco");
$r_beneficiario=ejecutar($q_beneficiario);

$qente=("select nombre from entes where id_ente=$ente");
$rente=ejecutar($qente);
$fente=asignar_a($rente);

$q_estado=("select estados_clientes.estado_cliente from estados_clientes where estados_clientes.id_estado_cliente=$estado");
$r_estado=ejecutar($q_estado);
$f_estado=asignar_a($r_estado);

?>
<LINK REL="StyleSheet" HREF="../../public/stylesheets/impresiones.css">
<table class="tabla_citas"  cellpadding=0 cellspacing=0 > 
	<tr>
		<td class="descrip_main"> <img src="../../public/images/head.png" alt="logo"><br>RIF J-31180863-9</td>
		<td class="descrip_main" colspan="9"> Reporte Relaci&oacute;n 
<?php if($tipcliente=='TITULARES') echo "Clientes "."TITULARES"  ;
      else if($tipcliente=='BENEFICIARIOS') echo "Clientes "."BENEFICIARIOS";
	else echo "TODOS LOS CLIENTES";?> entre <?php echo "$inicio y $fin";?> a&ntilde;os,  <?
if($estado==0)	echo "Todos los Estados, "; else echo "en Estado "."$f_estado[estado_cliente], ";
if($ente=="0")echo "TODOS LOS ENTES";
else if($ente=="-01") echo "NATURALES";
else if($ente=="-02") echo "JURIDICOS";
else if($ente=="-03") echo "GUBERNAMENTALES";
else if($ente=="-04") echo "PRIVADOS";
else if($ente=="-05") echo "SINDICATOS"; 
else echo "del Ente "."$fente[nombre] ";?>  </td>     
	</tr>
 <br>

<?php 
	if($tipcliente=='TITULARES' or $tipcliente=='BENEFICIARIOS' or $tipcliente=='TODOS LOS CLIENTES'){?>
<tr>
		<td class="descrip_main">CLIENTE</td>   
		<td class="descrip_main">NOMBRES</td>     
		<td class="descrip_main">APELLIDOS</td> 
		<td class="descrip_main">CEDULA</td>  
		<td class="descrip_main">&nbsp;ESTADO</td> 
		<td class="descrip_main">&nbsp; FECHA DE NACIMIENTO</td> 
		<td class="descrip_main">&nbsp; EDAD</td> 
		<td class="descrip_main">ENTE</td> 
      
	<? if($tipcliente=='BENEFICIARIOS' or $tipcliente=='TODOS LOS CLIENTES'){?>
	  
		<td class="descrip_main">&nbsp; PARENTESCO</td>      
		      
	</tr>
<?php }}
	     $t=0;$b=0;
		 
	     while($f_titular=asignar_a($r_titular,NULL,PGSQL_ASSOC))
		{

if  (calcular_edad($f_titular['fecha_nacimiento'])>=$inicio &&  calcular_edad($f_titular['fecha_nacimiento'])<=$fin) { 
if($tipcliente=='TITULARES' or $tipcliente=='TODOS LOS CLIENTES'){

 echo"
            <tr> 

		    <td class=\"tdtituloss\">$f_titular[id_titular]</td>   
	            <td class=\"tdtituloss\">$f_titular[nombres]</td>  
	            <td class=\"tdtituloss\">$f_titular[apellidos]</td>      
	            <td class=\"tdtituloss\">$f_titular[cedula]</td>   
	            <td class=\"tdtituloss\">&nbsp; $f_titular[estado_cliente]</td>
	            <td class=\"tdtituloss\">&nbsp; $f_titular[fecha_nacimiento]</td>
	            <td class=\"tdtituloss\">";?><?php echo calcular_edad($f_titular['fecha_nacimiento']);
			
	    echo"   <td class=\"tdtituloss\">$f_titular[nombre]</td>"; ?>      
	                 
	        </tr>
<?php

	$t++;}
		}
		}

     while($f_beneficiario=asignar_a($r_beneficiario,NULL,PGSQL_ASSOC))
		{

if  (calcular_edad($f_beneficiario['fecha_nacimiento'])>=$inicio &&  calcular_edad($f_beneficiario['fecha_nacimiento'])<=$fin) {
if($tipcliente=='BENEFICIARIOS' && $f_beneficiario['id_beneficiario']>0 or $tipcliente=='TODOS LOS CLIENTES' or $f_titular['id_titular']>0){	
	  echo"
	<tr> 
		    <td class=\"tdtituloss\">$f_beneficiario[id_beneficiario]</td>   
	            <td class=\"tdtituloss\">$f_beneficiario[nombres]</td>  
	            <td class=\"tdtituloss\">$f_beneficiario[apellidos]</td>      
	            <td class=\"tdtituloss\">$f_beneficiario[cedula]</td>   
	            <td class=\"tdtituloss\">&nbsp; $f_beneficiario[estado_cliente]</td>
	            <td class=\"tdtituloss\">&nbsp; $f_beneficiario[fecha_nacimiento]</td>
	            <td class=\"tdtituloss\">";?><?php echo calcular_edad($f_beneficiario['fecha_nacimiento']);?>
<?            echo "<td class=\"tdtituloss\">$f_beneficiario[nombre]</td>
<td class=\"tdtituloss\">&nbsp; $f_beneficiario[parentesco]</td>" ?>
			</td>       
	                 
	</tr>
<?php
		$b++;}
		}
		}
	?>

	<tr> <td colspan =9 >&nbsp;</td>
	</tr>
</table>
