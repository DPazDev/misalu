<?php
include ("../../lib/jfunciones.php");
sesion();

//$servicio=$_REQUEST[servicio];
list($id_ente,$ente)=explode("@",$_REQUEST['ente']);

$dateField1=$_REQUEST[dateField1];
$dateField2=$_REQUEST[dateField2];
$sucursal=$_REQUEST[sucursal];
$servicio=$_REQUEST[servicio];
$tipo_ente=$_REQUEST[tipo_ente];
$ente=$_REQUEST[ente];
$tipo_cliente=$_REQUEST[tipo_cliente];
$fechaimpreso=date("d-m-Y");

/* **** busco el usuario **** */
$id_admin= $_SESSION['id_usuario_'.empresa];
$q_admin=("select admin.*,sucursales.* from admin where admin.id_admin='$id_admin' and admin.id_sucursal=sucursales.id_sucursal");
$r_admin=ejecutar($q_admin);
$f_admin=asignar_a($r_admin);




if  ($sucursal==0){
	$sucursales="and admin.id_sucursal>0";
	}
	else
	{
		$sucursales="and admin.id_sucursal=$sucursal";
		}

if  ($servicio==0){
	$servicios="and gastos_t_b.id_servicio>0";
	$servicios1="servicios.id_servicio>0";
	}
	else
	{
		$servicios="and gastos_t_b.id_servicio=$servicio";
		$servicios1="servicios.id_servicio=$servicio";
		}
		if  ($tipo_ente==0){
	$tipo_entes="and entes.id_tipo_ente>0";
	$tiposentes="Todos los Tipos";
	}
	else
	{
		$tipo_entes="and entes.id_tipo_ente=$tipo_ente";
		
		if  ($tipo_ente==1){
		$tiposentes="Natural";
	}
		if  ($tipo_ente==2){
		$tiposentes="Juridica";
	}
		if  ($tipo_ente==3){
		$tiposentes="Gubernamental";
	}
		if  ($tipo_ente==4){
		$tiposentes="Privados";
	}
	if  ($tipo_ente==5){
		$tiposentes="Sindicatos";
	}
		
		
	}
	
		if  ($ente==0){
	$entes="and entes.id_ente>0";
	$todosentes="Todos los Entes";
	$entes1="entes.id_ente>0";
	}
	else
	{
		$entes="and entes.id_ente=$ente";
		$entes1="entes.id_ente=$ente";
		$r_ente1=pg_query("select entes.id_ente,entes.nombre from entes where entes.id_ente=$ente");
	($f_ente1=pg_fetch_array($r_ente1, NULL, PGSQL_ASSOC));
	$todosentes=$f_ente1[nombre];
	}
			if  ($tipo_cliente==0){
	$tipo_clientes="and procesos.id_beneficiario=0";
	$tipo='Titulares';
	}
			if  ($tipo_cliente==1){
			$tipo_clientes="and procesos.id_beneficiario>0";
			$tipo='Beneficiarios';
	}
	if  ($tipo_cliente==2){
			$tipo_clientes="and procesos.id_beneficiario>=0";
			$tipo='Titulares + Beneficiarios';
	}
	
$q_ente="select entes.id_ente,entes.nombre from entes where $entes1 $tipo_entes";
$r_ente = ejecutar($q_ente);

			$q_servicios = "select * from servicios where $servicios1 and servicios.id_servicio<>12 and servicios.id_servicio<>14 order by servicios.servicio";
$r_servicios = ejecutar($q_servicios);
$num_s=num_filas($r_servicios);
	



?>
<link HREF="../../public/stylesheets/impresiones.css"   rel="stylesheet" type="text/css">
<script language="JavaScript" type="text/javascript" src="../../public/javascripts/scripts.js"></script>
<table   border=0 class="tabla_citas"  cellpadding=0 cellspacing=0>
<tr>
<td colspan=1 class="logo">
<img src="../../public/images/head.png">
</td>
<td colspan=2 class="titulo">

</td>
<td colspan=1 class="titulo">

</td>
</tr>
<tr>
<td colspan=1 class="titulo2">
Rif: J-31180863-9
</td>
<td colspan=2 class="titulo">

</td>
<td colspan=1 class="titulo1">
<?php echo "$f_admin[sucursal] $fechaimpreso"?>
</td>
</tr>
<tr>
<td colspan=4>
<br>
</br>
</td>
</tr>


<tr>
<td colspan=1 class="datos_cliente">
Ente(s):
</td>
<td colspan=2 class="datos_cliente">
<?php echo "$todosentes";?>
</td>
<td colspan=1 class="datos_cliente">

</td>
</tr>
<tr>
<td colspan=1 class="datos_cliente">
Tipo(s) de Ente:
</td>
<td colspan=2 class="datos_cliente">
<?php echo "$tiposentes";?>
</td>
<td colspan=1 class="datos_cliente">
</td>
</tr>
<tr>
<td colspan=4>
<br>
</br>
</td>
</tr>

 <tr>
  <td  colspan=<?php echo "$num_s +3"?> class="titulo3"> Gastos de <?php echo  $tipo?> </td>
  </tr>
  <tr>
	<td class="titulo3">Ente</td>  
    
	<?php 
		while($f_servicios = asignar_a($r_servicios)){
	
	?>
	<td class="titulo3"><?php echo $f_servicios[codigo] ?></td>
	<?php
	}
	?>
	
	<td class="titulo3">TS</td>
    
	
	<td class="titulo3">Monto</td>	
    </tr>
<?php


		while($f_ente = asignar_a($r_ente)){
			$monto=0;
			$num_filas1=0;
			$q_servicios1 = "select * from servicios where $servicios1 and servicios.id_servicio<>12 and servicios.id_servicio<>14 order by servicios.servicio";
$r_servicios1 = ejecutar($q_servicios1);
			?>
			<tr>
    <td class="t"><?php echo $f_ente[nombre];?></td>
	
			<?php
	
			while($f_servicios1 = asignar_a($r_servicios1)){
			
			$q_procesos = "select procesos.id_proceso,count(gastos_t_b.id_proceso) from procesos,gastos_t_b where procesos.id_proceso=gastos_t_b.id_proceso and procesos.fecha_recibido>='$dateField1' and procesos.fecha_recibido<='$dateField2' and procesos.id_admin=admin.id_admin $sucursales and procesos.id_titular=titulares.id_titular and titulares.id_ente=entes.id_ente and entes.id_ente=$f_ente[id_ente] $tipo_entes and gastos_t_b.id_servicio=$f_servicios1[id_servicio]  and gastos_t_b.id_servicio<>7 and gastos_t_b.id_servicio<>12  and procesos.id_estado_proceso<>13 and procesos.id_estado_proceso<>14 and procesos.id_estado_proceso<>6 $tipo_clientes group by procesos.id_proceso";
$r_procesos = ejecutar($q_procesos);
$num_filas=num_filas($r_procesos);
$num_filas1=$num_filas1 + $num_filas;
$num_filas2=$num_filas2 + $num_filas;


$q_gastos = "select gastos_t_b.id_proceso,gastos_t_b.monto_aceptado from procesos,gastos_t_b where procesos.id_proceso=gastos_t_b.id_proceso and procesos.fecha_recibido>='$dateField1' and procesos.fecha_recibido<='$dateField2' and procesos.id_admin=admin.id_admin $sucursales and procesos.id_titular=titulares.id_titular and titulares.id_ente=entes.id_ente and entes.id_ente=$f_ente[id_ente] $tipo_entes  and gastos_t_b.id_servicio=$f_servicios1[id_servicio] and gastos_t_b.id_servicio<>7 and gastos_t_b.id_servicio<>12  and procesos.id_estado_proceso<>13 and procesos.id_estado_proceso<>14 and procesos.id_estado_proceso<>6 $tipo_clientes";
					$r_gastos = ejecutar($q_gastos);
					
		while($f_gastos = asignar_a($r_gastos)){
		$monto= $monto + $f_gastos[monto_aceptado];
		$monto1= $monto1 + $f_gastos[monto_aceptado];
		}
		?>

	<td class="tdcamposcc"><?php echo $num_filas;?></td>
	<?php
	}
	?>
	
    <td class="tdcamposcc"><?php echo $num_filas1;?></td>	
    <td class="tdcamposcc"><?php echo formato_montos($monto);?></td>

</tr>
	<?php
	}
	?>
<tr>
	<td colspan=<?php echo "$num_s +3"?> class="tdcamposc"></td>  
    
	
	<td class="tdcamposc"></td>
	
	
	<td  class="tdcamposc"><?php echo $num_filas2;?></td>
    
	
	<td class="tdcamposc"><?php echo formato_montos($monto1);?></td>	
    </tr>

</table>

