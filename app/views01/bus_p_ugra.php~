<?php
include ("../../lib/jfunciones.php");
sesion();
header('Content-Type: text/xml; charset=ISO-8859-1');
$proceso=$_REQUEST['proceso'];
/* **** busco el usuario **** */
$id_admin= $_SESSION['id_usuario_'.empresa];
$q_admin=("select * from admin where admin.id_admin='$id_admin'");
$r_admin=ejecutar($q_admin);
$f_admin=asignar_a($r_admin);
$q_espera="select * from procesos where procesos.id_proceso='$proceso'";
$r_espera=ejecutar($q_espera);
$f_espera=asignar_a($r_espera);
if ($f_espera[id_estado_proceso]==13)  {

$id_tipo_servicio=0;
$espera="ESPERA";
}
else
{
	if ($f_espera[id_estado_proceso]==14)  {

$id_tipo_servicio=0;
$espera="ANULADA";
}
else
{
$q_tiposervicio="select * from gastos_t_b where gastos_t_b.id_proceso='$proceso'";
$r_tiposervicio=ejecutar($q_tiposervicio);
$f_tiposervicio=asignar_a($r_tiposervicio);

if ($f_tiposervicio[id_tipo_servicio]==5)  {

$id_tipo_servicio=5;
}
else
{
$id_tipo_servicio=$f_tiposervicio[id_tipo_servicio];
}
}
}
$q_poliza="select procesos.id_proceso,procesos.nu_planilla,estados_procesos.estado_proceso,gastos_t_b.id_tipo_servicio,gastos_t_b.descripcion as descrip,gastos_t_b.nombre,gastos_t_b.id_tipo_servicio,gastos_t_b.id_servicio,gastos_t_b.id_proveedor,gastos_t_b.fecha_cita,gastos_t_b.hora_cita,gastos_t_b.enfermedad,gastos_t_b.monto_aceptado,procesos.fecha_recibido,procesos.comentarios from gastos_t_b,procesos,estados_procesos where  gastos_t_b.id_proceso=procesos.id_proceso and procesos.id_proceso='$proceso' and procesos.id_estado_proceso=estados_procesos.id_estado_proceso";
$r_poliza=ejecutar($q_poliza);
$f_poliza=asignar_a($r_poliza);

$q_poliza1="select gastos_t_b.id_gasto_t_b,gastos_t_b.descripcion as descrip,gastos_t_b.nombre,gastos_t_b.id_tipo_servicio,
gastos_t_b.factura,gastos_t_b.id_servicio,gastos_t_b.id_proveedor,gastos_t_b.fecha_cita,
gastos_t_b.hora_cita,gastos_t_b.enfermedad,gastos_t_b.monto_aceptado,procesos.fecha_recibido,
procesos.comentarios,coberturas_t_b.id_cobertura_t_b,coberturas_t_b.id_titular,
coberturas_t_b.id_beneficiario,polizas.* from polizas,coberturas_t_b,gastos_t_b,procesos,
propiedades_poliza where polizas.id_poliza=propiedades_poliza.id_poliza and 
propiedades_poliza.id_propiedad_poliza=coberturas_t_b.id_propiedad_poliza and 
coberturas_t_b.id_cobertura_t_b=gastos_t_b.id_cobertura_t_b and 
gastos_t_b.id_proceso=procesos.id_proceso and procesos.id_proceso='$proceso'";
$r_poliza1=ejecutar($q_poliza1);


/* **** busco si es titular **** */
$q_cliente=("select clientes.id_cliente,clientes.nombres,clientes.apellidos,clientes.cedula,estados_clientes.estado_cliente,titulares.id_titular,titulares.id_ente,entes.nombre from clientes,titulares,estados_t_b,estados_clientes,entes,procesos
                where procesos.id_proceso='$proceso' and procesos.id_titular=titulares.id_titular and procesos.id_beneficiario=0 and clientes.id_cliente=titulares.id_cliente and titulares.id_titular=estados_t_b.id_titular and estados_t_b.id_beneficiario=0 and estados_t_b.id_estado_cliente=estados_clientes.id_estado_cliente and titulares.id_ente=entes.id_ente and estados_clientes.id_estado_cliente=4");
$r_cliente=ejecutar($q_cliente) or mensaje(ERROR_BD);
$num_filas=num_filas($r_cliente);
$titular=1;

/* **** busco si es beneficiario **** */
if ($num_filas == 0) { 
$q_clienteb=("select clientes.id_cliente,clientes.nombres,clientes.apellidos,clientes.cedula,estados_clientes.estado_cliente,
beneficiarios.id_beneficiario,beneficiarios.id_titular,entes.nombre 
from clientes,estados_clientes,beneficiarios,entes,procesos,estados_t_b,titulares  where 
procesos.id_proceso='$proceso' and procesos.id_beneficiario=beneficiarios.id_beneficiario and clientes.id_cliente=beneficiarios.id_cliente and beneficiarios.id_beneficiario=estados_t_b.id_beneficiario 
and estados_t_b.id_estado_cliente=estados_clientes.id_estado_cliente and beneficiarios.id_titular=titulares.id_titular 
and titulares.id_ente=entes.id_ente and estados_clientes.id_estado_cliente=4");
$r_clienteb=ejecutar($q_clienteb) or mensaje(ERROR_BD);
$num_filasb=num_filas($r_clienteb);
$titular=0;
}

if ($num_filas==0 and $num_filasb==0){

?>
<link HREF="../../public/stylesheets/estilos.css"   rel="stylesheet" type="text/css">
<script language="JavaScript" type="text/javascript" src="../../public/javascripts/scripts.js"></script>
<table class="tabla_cabecera5"  cellpadding=0 cellspacing=0>

<tr> <td colspan=4 class="titulo_seccion">El Numero de Orden no existe </td>
      </tr>

	
</table>
<?php
}
else
{
?>

<table class="tabla_cabecera5"  cellpadding=0 cellspacing=0>

<?php if ($titular==1) {

/* ***** repita para buscar al titular **** */
$i=0;
while($f_cliente=asignar_a($r_cliente,NULL,PGSQL_ASSOC)){
    $cliente="$f_cliente[nombres] $f_cliente[apellidos]";
    $ente="$f_cliente[nombre]";
$i++;
$q_datos=("select estados_procesos.estado_proceso,procesos.comentarios,procesos.comentarios_gerente,procesos.comentarios_medico,admin.nombres,admin.apellidos,gastos_t_b.fecha_cita,gastos_t_b.nombre,gastos_t_b.descripcion,gastos_t_b.enfermedad,gastos_t_b.id_servicio,coberturas_t_b.id_cobertura_t_b,propiedades_poliza.cualidad,coberturas_t_b.id_propiedad_poliza,

coberturas_t_b.monto_actual,coberturas_t_b.id_organo,servicios.servicio,gastos_t_b.id_tipo_servicio

from propiedades_poliza,coberturas_t_b,gastos_t_b,estados_procesos,procesos,admin,servicios where

gastos_t_b.id_proceso=procesos.id_proceso and gastos_t_b.id_cobertura_t_b=coberturas_t_b.id_cobertura_t_b and coberturas_t_b.id_propiedad_poliza=propiedades_poliza.id_propiedad_poliza

and gastos_t_b.id_proceso=procesos.id_proceso and procesos.id_proceso='$proceso' and procesos.id_admin=admin.id_admin and gastos_t_b.id_servicio=servicios.id_servicio and procesos.id_estado_proceso=estados_procesos.id_estado_proceso ");
$r_datos=ejecutar($q_datos) or mensaje(ERROR_BD);
$f_datos=asignar_a($r_datos);


$q_tiposer=("select  * from tipos_servicios where tipos_servicios.id_tipo_servicio=$id_tipo_servicio");
$r_tiposer=ejecutar($q_tiposer) or mensaje(ERROR_BD);
$f_tiposer=asignar_a($r_tiposer);

	

?>
<tr> <td colspan=4 class="titulo_seccion">  <?php echo  "Datos de Este Cliente como Titular"?> <input  type="hidden" size="10"  name="id_cobertura_t_b" class="campos" maxlength="10" value=<?php echo $f_cobertura[id_cobertura_t_b]; ?>></td></tr>

<tr>
		<td class="tdtitulos">Nombres y Apellidos del Titular</td>
		<td class="tdcampos"><?php echo $f_cliente[nombres]?> <?php echo $f_cliente[apellidos]?></td>
		<td class="tdtitulos">Ente</td>
                <td class="tdcampos"><?php echo $f_cliente[nombre]?></td>
	</tr>		
	
	<tr> 
                <td class="tdtitulos">Estado</td>
                <td class="tdcamposr">
		<?php echo $f_cliente[estado_cliente]?></td>
	</tr>


<tr>
		<td class="tdtitulos"> Servicio</td>
		<td class="tdcampos"><?php echo $f_datos[servicio]?> (<?php echo $f_tiposer[tipo_servicio]?>)</td>
		<td class="tdtitulos"> Especialidad</td>
                <td class="tdcampos"><?php echo $f_datos[nombre]?></td>
	</tr>		
	
	<tr>
		<td class="tdtitulos"> Descripcion</td>
		<td class="tdcampos"><?php echo $f_datos[descripcion]?> </td>
		<td class="tdtitulos"> Enfermedad</td>
                <td class="tdcampos"><?php echo $f_datos[enfermedad]?></td>
	</tr>
	<tr>
		<td class="tdtitulos"> Fecha Cita</td>
		<td class="tdcampos"><?php echo $f_datos[fecha_cita]?> </td>
		<td class="tdtitulos"> Analista</td>
                <td class="tdcampos"><?php echo $f_datos[nombres]?> <?php echo $f_datos[apellidos]?></td>
	</tr>
	<tr>
	 <tr>
                <td class="tdtitulos"> Estado del Proceso</td>
                <td class="tdcampos"><?php echo $f_datos[estado_proceso]?></td>           
		<td class="tdtitulos"> Comentarios Operador</td>
		<td class="tdcampos"><textarea class="campos"  name="cooperador" cols=18 rows=3><?php echo $f_datos[comentarios]?></textarea> </td>
		
	</tr>
     <tr>
	<td class="tdtitulos"> Comentarios Gerente Operacion</td>
                <td class="tdcampos"><textarea class="campos" name="cogerent" cols=18 rows=3><?php echo $f_datos[comentarios_gerente]?></textarea></td> 
                <td class="tdtitulos"> Comentarios Gerente Medico</td>
                <td class="tdcampos"><textarea class="campos" name="comedico" cols=18 rows=3><?php echo $f_datos[comentarios_medico]?></textarea></td>                     
        </tr>
		<?php
		}
		}
else
{
if ($titular==0)
{

/* **** repita para beneficiario **** */

while($f_clienteb=asignar_a($r_clienteb,NULL,PGSQL_ASSOC)){
$i++;
$q_clientet=("select clientes.id_cliente,clientes.nombres,clientes.apellidos,clientes.cedula,
estados_clientes.estado_cliente,titulares.id_titular,titulares.id_ente,entes.nombre 
from clientes,titulares,estados_t_b,estados_clientes,entes
                where titulares.id_titular=$f_clienteb[id_titular] and clientes.id_cliente=titulares.id_cliente and 
titulares.id_titular=estados_t_b.id_titular and estados_t_b.id_beneficiario=0 and 
estados_t_b.id_estado_cliente=estados_clientes.id_estado_cliente and titulares.id_ente=entes.id_ente");

$r_clientet=ejecutar($q_clientet) or mensaje(ERROR_BD);
$f_clientet=asignar_a($r_clientet);
   $cliente="$f_clientet[nombres] $f_clientet[apellidos]";
    $ente="$f_clientet[nombre]";

$q_datos=("select estados_procesos.estado_proceso,procesos.comentarios,procesos.comentarios_gerente,procesos.comentarios_medico,admin.nombres,admin.apellidos,gastos_t_b.fecha_cita,gastos_t_b.nombre,gastos_t_b.descripcion,gastos_t_b.enfermedad,coberturas_t_b.id_cobertura_t_b,propiedades_poliza.cualidad,coberturas_t_b.id_propiedad_poliza,

coberturas_t_b.monto_actual,coberturas_t_b.id_organo,servicios.servicio,gastos_t_b.id_tipo_servicio

from propiedades_poliza,coberturas_t_b,gastos_t_b,estados_procesos,procesos,admin,servicios where

gastos_t_b.id_proceso=procesos.id_proceso and gastos_t_b.id_cobertura_t_b=coberturas_t_b.id_cobertura_t_b and coberturas_t_b.id_propiedad_poliza=propiedades_poliza.id_propiedad_poliza

and gastos_t_b.id_proceso=procesos.id_proceso and procesos.id_proceso='$proceso' and procesos.id_admin=admin.id_admin and gastos_t_b.id_servicio=servicios.id_servicio and procesos.id_estado_proceso=estados_procesos.id_estado_proceso ");
$r_datos=ejecutar($q_datos) or mensaje(ERROR_BD);
$f_datos=asignar_a($r_datos);



$q_tiposer=("select  * from tipos_servicios where tipos_servicios.id_tipo_servicio=$id_tipo_servicio");
$r_tiposer=ejecutar($q_tiposer) or mensaje(ERROR_BD);
$f_tiposer=asignar_a($r_tiposer);
?>
<tr> <td colspan=4 class="titulo_seccion">  <?php echo  "Datos del Cliente como Beneficiario"?><input  type="hidden" size="10"  name="id_cobertura_t_b" class="campos" maxlength="10" value=<?php echo $f_cobertura[id_cobertura_t_b]; ?>></td></tr>

<tr>
                <td class="tdtitulos">Nombres y Apellidos del titular</td>
                <td class="tdcampos"><?php echo $f_clientet[nombres]?> <?php echo $f_clientet[apellidos]?></td>
                <td class="tdtitulos">Cedula Titular</td>
                <td class="tdcampos"><?php echo $f_clientet[cedula]?></td>
        </tr>


        <tr>
         <td class="tdtitulos">Ente</td>
                <td class="tdcampos"><?php echo $f_clientet[nombre]?></td>
                <td class="tdtitulos">Estado</td>
                <td class="tdcamposr"><?php echo $f_clientet[estado_cliente]?></td>
        </tr>

<tr>
		<td class="tdtitulos">Nombres y Apellidos del Beneficiario</td>
		<td class="tdcampos"><?php echo $f_clienteb[nombres]?> <?php echo $f_clienteb[apellidos]?></td>
		<td class="tdtitulos">Ente</td>
                <td class="tdcampos"><?php echo $f_clienteb[nombre]?></td>
	</tr>		
	
	<tr> 
                <td class="tdtitulos">Estado</td>
                <td class="tdcamposr">
		<?php echo $f_clienteb[estado_cliente]?></td>
	</tr>


<tr>
		<td class="tdtitulos"> Servicio</td>
		<td class="tdcampos"><?php echo $f_datos[servicio]?> (<?php echo $f_tiposer[tipo_servicio]?>)</td>
		<td class="tdtitulos"> Especialidad</td>
                <td class="tdcampos"><?php echo $f_datos[nombre]?></td>
	</tr>		
	
	<tr>
		<td class="tdtitulos"> Descripcion</td>
		<td class="tdcampos"><?php echo $f_datos[descripcion]?> </td>
		<td class="tdtitulos"> Enfermedad</td>
                <td class="tdcampos"><?php echo $f_datos[enfermedad]?></td>
	</tr>
	<tr>
		<td class="tdtitulos"> Fecha Cita</td>
		<td class="tdcampos"><?php echo $f_datos[fecha_cita]?> </td>
		<td class="tdtitulos"> Analista</td>
                <td class="tdcampos"><?php echo $f_datos[nombres]?> <?php echo $f_datos[apellidos]?></td>
	</tr>
	<tr>
	 <tr>
                <td class="tdtitulos"> Estado del Proceso</td>
                <td class="tdcampos"><?php echo $f_datos[estado_proceso]?></td>           
		<td class="tdtitulos"> Comentarios Operador</td>
		<td class="tdcampos"><textarea class="campos" name="cooperador" cols=18 rows=3>  <?php echo $f_datos[comentarios]?></textarea> </td>
		
	</tr>
     <tr>
	<td class="tdtitulos"> Comentarios Gerente Operacion</td>
                <td class="tdcampos"><textarea class="campos" name="cogerent" cols=18 rows=3>  <?php echo $f_datos[comentarios_gerente]?></textarea></td> 
                <td class="tdtitulos"> Comentarios Gerente Medico</td>
                <td class="tdcampos"><textarea class="campos" name="comedico" cols=18 rows=3> <?php echo $f_datos[comentarios_medico]?></textarea></td>                     
        </tr>

<?php
}
}
}
?>

<tr> <td colspan=4 class="titulo_seccion">  <?php echo  "Datos de la Orden de Atencion en Estado $f_poliza[estado_proceso] $espera"?></td></tr>
<tr> 
               
		<td  class="tdtitulos">Fecha de Recepcion:   </td>
		<td class="tdcampos"><input readonly type="hidden" size="10" id="dateField1" name="fechar" class="campos" maxlength="10" value=<?php echo  $f_poliza[fecha_recibido]; ?>>
 <?php echo $f_poliza[fecha_recibido]; ?>

                </td>
		<td class="tdtitulos">Fecha de Cita:</td>
		<td class="tdcampos"> <input readonly type="hidden" size="10" id="dateField2" name="fechac" class="campos" maxlength="10" value="<?php echo $f_poliza[fecha_cita]?>">
<?php echo $f_poliza[fecha_cita]?>
                </td>
	</tr>
	
   <tr>
		 		<td class="tdtitulos">Hora Cita</td>
              	<td class="tdcampos"><input class="campos" type="hidden" name="tiposerv" maxlength=128 size=20 value="<?php echo $f_poliza[id_tipo_servicio]?>"   ><input class="campos" type="hidden" name="servicio" maxlength=128 size=20 value="<?php echo $f_poliza[id_servicio]?>" ><input class="campos" type="hidden" name="proveedor" maxlength=128 size=20 value="<?php echo $f_poliza[id_proveedor]?>"   ><input class="campos" type="hidden" name="horac" maxlength=128 size=20 value="<?php echo $f_poliza[hora_cita]?>"   ><?php echo $f_poliza[hora_cita]?></td>
			           <input class="campos" type="hidden" name="numpro" maxlength=128 size=20 value="<?php echo $f_poliza[factura]?>"   >
				<td class="tdtitulos">Cuadro Medico</td>
              	<td class="tdcampos"><?php echo $f_poliza[enfermedad] ?></td>
	</tr>		
	
		<tr>
			<td colspan=1 class="tdtitulos">Comentario</td>
              	<td colspan=3 class="tdcampos"><?php echo $f_poliza[comentarios]?></td>
		</tr>		
	<?php 
    $q_carta_rechazo="select * from tbl_control_cartas where tbl_control_cartas.id_proceso='$proceso' and tbl_control_cartas.activar='0' ";
    $r_carta_rechazo=ejecutar($q_carta_rechazo);
    $num_filascr=num_filas($r_carta_rechazo);
    if ($num_filascr>0){
    $f_carta_rechazo=asignar_a($r_carta_rechazo);
   
?>
 <tr> <td colspan=4 class="titulo_seccion"> Esta Orden ya Tiene un Pago Unico de Gracia
    <?php
			$url="'views01/ipago_gracia.php?proceso=$proceso&motivo=$f_carta_rechazo[motivo]&comentario=$f_carta_rechazo[comentario]&cliente=$cliente&nomente=$ente&porcentaje=$f_carta_rechazo[porcentaje]&fecha_recibido=$f_datos[fecha_recibido]'";
			?> <a title="Imprimir Carta del Pago Unico de Gracia" href="javascript: imprimir(<?php echo $url; ?>);" class="boton"> Imprimir Pago Unico de Gracia </a>
    </td></tr>
    <?php
     }
 else
 {
    ?>
	<tr>
				<td colspan=1 class="tdtitulos">Nombre del Gasto</td>
              	<td colspan=2 class="tdtitulos">Descripcion</td>
				<td colspan=1 class="tdtitulos">Gasto</td>
	</tr>	
		<?php
				$i=0;
		while($f_poliza1=asignar_a($r_poliza1,NULL,PGSQL_ASSOC)){
		$totalmonto=$totalmonto+ $f_poliza1[monto_aceptado];
		$descri=$f_poliza1[descrip];
			$i++;
		?>
	<tr>
				<td colspan=1 class="tdcampos"><?php echo $f_poliza1[nombre] ?></td>
				<td colspan=2 class="tdcampos"><?php echo " $f_poliza1[descrip] Factura $f_poliza1[factura]"?> </td>
				<td colspan=1 class="tdcampos"><?php echo $f_poliza1[monto_aceptado]?>
				<input class="campos" type="hidden"  id="decrips_<?php echo $i?>" name="decrips" maxlength=250 size=20 value="<?php echo $f_poliza1[nombre]?>">
                <input class="campos" type="hidden"  id="preforma_<?php echo $i?>" name="preforma" maxlength=128 size=7 value="<?php echo $f_poliza1[factura]?>">
                <input class="campos" type="hidden"  id="id_gasto_<?php echo $i?>" name="id_gasto_" maxlength=128 size=7 value="<?php echo $f_poliza1[id_gasto_t_b]?>">
                <input class="campos" type="checkbox"  id="check_<?php echo $i?>"  name="checkl" maxlength=128 size=20 value="">
				
				</td>
				
				
		<?php
		}
		echo "<input type=\"hidden\" name=\"con1\" value=\"$i\">";
		?>
	</tr>		
			<tr>
				<td colspan=1 class="tdtitulos"></td>
              	<td colspan=2 class="tdtitulos">Total</td>
				<td colspan=1 class="tdtitulos"><?php echo formato_montos($totalmonto);?></td>
	</tr>	
	
	<tr> <td colspan=4 class="titulo_seccion"> Paragrafo</td></tr>


<?php
$q_paragrafo="select tbl_paragrafo.*,tbl_tipos_paragrafo.*  from tbl_paragrafo,tbl_tipos_paragrafo where tbl_tipos_paragrafo.id_tipo_paragrafo=tbl_paragrafo.id_tipo_paragrafo order by tbl_tipos_paragrafo.tipo_paragrafo";
$r_paragrafo=ejecutar($q_paragrafo);

if ($f_poliza[id_servicio]==1 || $f_poliza[id_servicio]==10 || ($f_poliza[id_tipo_servicio]==0 and ($f_poliza[id_servicio]==2 || $f_poliza[id_servicio]==3 || $f_poliza[id_servicio]==8 || $f_poliza[id_servicio]==11  || $f_poliza[id_servicio]==13 || $f_poliza[id_servicio]==10) )){
?>
<tr>
<td  colspan=4 class="tdtitulos">Seleccione  el Paragrafo.</td>
</tr>
		<?php		
		$i2=0;
		while($f_paragrafo=asignar_a($r_paragrafo,NULL,PGSQL_ASSOC)){
			$i2++;
	
		?>
<tr>
	
<td   colspan=1 class="tdcampos">
<input class="campos" type="text" id="tipo_paragrafo_<?php echo $i2?>" name="tipo_paragrafo" maxlength=128 size=15 value="<?php echo $f_paragrafo[tipo_paragrafo]?>"    ><input class="campos" type="checkbox" <?php echo $ban ?> id="check2_<?php echo $i2?>" name="checkl2" maxlength=128 size=20 value="">  
			</td>
			<td colspan=3 class="tdcampos"><textarea class="campos"  id="paragrafo_<?php echo $i2?>" name="paragrafo" cols=70 rows=3><?php echo $f_paragrafo[paragrafo]?></textarea></td>
	
		</tr>
				<?php
		}
		echo "<input type=\"hidden\" name=\"conexa\" value=\"$i2\">";
		?>
<?php

}

?>

<tr>
	
<tr>
<td colspan=1 class="tdtitulos">Procentaje a Cancelar
			</td>
			<td colspan=1 class="tdtitulos"><input  type="text" size="10"  id="porcentaje" name="procentaje" class="campos" maxlength="10" value="0" onkeyUp="return ValNumero(this);" onkeypress="return event.keyCode!=13">
			</td>
			<td colspan=2 class="tdtitulos"><a href="#"  OnClick="pago_gracia();" class="boton"> Procesar Pago Unico de Gracia </a>
			</td>
</tr>
		
		
</table>
<?php
}
}
?>
