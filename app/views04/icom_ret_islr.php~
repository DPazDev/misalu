<?php
include ("../../lib/jfunciones.php");
sesion();

$numcheque=$_REQUEST[numcheque];
$banco=$_REQUEST[banco];
$codigo=$_REQUEST[codigo];
$cedula=$_REQUEST[cedula];
$nombreprov=$_REQUEST[nombreprov];
$prov=$_REQUEST[prov];
$ente=$_REQUEST[ente];
$fecha_emision=$_REQUEST[fecha_emision];
$direccionpro=$_REQUEST[direccionpro];
$id_proveedor=$_REQUEST[id_proveedor];
$compro_retiva_islr=$_REQUEST[compro_retiva_islr];
$personaprov=$_REQUEST['personaprov'];
$periodo=split("-",$compro_retiva_seniat);
$id_admin= $_SESSION['id_usuario_'.empresa];
/* busco el admin*/
$admin= $_SESSION['id_usuario_'.empresa];
$q_admin="select admin.*,sucursales.* from admin,sucursales where admin.id_admin='$admin' and admin.id_sucursal=sucursales.id_sucursal";
$r_admin=ejecutar($q_admin);
$f_admin=asignar_a($r_admin);
/* **** Se registra lo que hizo el usuario**** */

$log="Imprimo o vio el cheque o recibo   con codigo numero $codigo";
logs($log,$ip,$admin);

/* **** Fin de lo que hizo el usuario **** */
/* busco el banco */
$q_banco=("select tbl_bancos.*,bancos.*,facturas_procesos.* from tbl_bancos,bancos,facturas_procesos  where tbl_bancos.id_ban=bancos.id_ban and bancos.id_banco=$banco and bancos.id_banco=facturas_procesos.id_banco and facturas_procesos.codigo='$codigo'");

$r_banco=ejecutar($q_banco);
$f_banco=asignar_a($r_banco);
/* **** compraro si busco proveedor persona o proveedor clinica **** */
if ($prov==6){
    $q_proveedor=("select   
                                        comisionados.nombres,
                                        comisionados.apellidos,
                                        comisionados.cedula,
                                        actividades_pro.codigo,
                                        actividades_pro.porcentaje,
                                        actividades_pro.actividad,
                                        actividades_pro.sustraendo
                            from
                                        comisionados,actividades_pro,facturas_procesos 
                            where
                                        comisionados.id_comisionado='$id_proveedor' and 
                                        comisionados.id_comisionado=facturas_procesos.id_proveedor and 
                                        facturas_procesos.codigo='$codigo' and 
                                        facturas_procesos.id_act_pro=actividades_pro.id_act_pro
");
$r_proveedor=ejecutar($q_proveedor);
$f_proveedor=asignar_a($r_proveedor);
$nombrepro="$f_proveedor[nombres] $f_proveedor[apellidos] ";
echo "paso";
$rifpro=$f_proveedor[cedula];
$direccionpro=$f_proveedor[direccioncheque];
$telefonospro=$f_proveedor[celular_pro];
$objetoretencion=$f_proveedor[actividad];
$porcentaje=100 * $f_proveedor[porcentaje];
$sustraendo=$f_proveedor[sustraendo];
    
    }
    else
    {
if ($prov==1){

/* **** BUSCO EL PROVEEDOR  persona**** */

$q_proveedor=("select   
                            personas_proveedores.nomcheque,personas_proveedores.rifcheque,
                            personas_proveedores.direccioncheque,personas_proveedores.celular_prov,
                            actividades_pro.codigo,actividades_pro.porcentaje,actividades_pro.actividad,
                            actividades_pro.sustraendo
                            from
                            personas_proveedores,actividades_pro,facturas_procesos 
                            where
                            personas_proveedores.id_persona_proveedor='$id_proveedor' and 
                            personas_proveedores.id_persona_proveedor=facturas_procesos.id_proveedor and 
                            facturas_procesos.codigo='$codigo' and 
                            facturas_procesos.id_act_pro=actividades_pro.id_act_pro
");
$r_proveedor=ejecutar($q_proveedor);
$f_proveedor=asignar_a($r_proveedor);
$nombrepro="$f_proveedor[nomcheque]";
$rifpro=$f_proveedor[rifcheque];
$direccionpro=$f_proveedor[direccioncheque];
$telefonospro=$f_proveedor[celular_pro];
$objetoretencion=$f_proveedor[actividad];
$porcentaje=100 * $f_proveedor[porcentaje];
$sustraendo=$f_proveedor[sustraendo];

}
else
{

/* **** BUSCO EL PROVEEDOR  clinica**** */

$q_proveedor="select 
                            clinicas_proveedores.nombre,clinicas_proveedores.direccion,
                            clinicas_proveedores.telefonos,clinicas_proveedores.rif,actividades_pro.codigo,
                            actividades_pro.actividad,actividades_pro.porcentaje,actividades_pro.sustraendo 
                         from 
                            clinicas_proveedores,proveedores,actividades_pro,facturas_procesos 
                         where 
                            clinicas_proveedores.id_clinica_proveedor=proveedores.id_clinica_proveedor and
                            proveedores.id_proveedor='$id_proveedor' and 
                            proveedores.id_proveedor=facturas_procesos.id_proveedor and 
                            facturas_procesos.codigo='$codigo' and 
                            facturas_procesos.id_act_pro=actividades_pro.id_act_pro

";
$r_proveedor=ejecutar($q_proveedor);
$f_proveedor=asignar_a($r_proveedor);
/**Juan Pablo**/
$busnomprov=("select clinicas_proveedores.nomcheque,clinicas_proveedores.rifcheque,clinicas_proveedores.direccioncheque
              from clinicas_proveedores,proveedores
               where
               proveedores.id_proveedor=$id_proveedor and
               proveedores.id_clinica_proveedor=clinicas_proveedores.id_clinica_proveedor;");
/**fin de Juan Pablo**/
$nombrepro="$f_proveedor[nombre]";
$rifpro=$f_proveedor[rif];
$direccionpro=$f_proveedor[direccion];
$telefonospro=$f_proveedor[telefonos];
$objetoretencion=$f_proveedor[actividad];
$porcentaje=100 * $f_proveedor[porcentaje];
$sustraendo=$f_proveedor[sustraendo];
/* **** FIN DE BUSCAR PROVEEDOR **** */
}
}
$q_facturas=("select * from facturas_procesos where facturas_procesos.codigo='$codigo'
");
$r_facturas=ejecutar($q_facturas);
$num_filas=num_filas($r_facturas);
if ($num_filas==0){
?>


<table class="tabla_cabecera5"  cellpadding=0 cellspacing=0>

<tr>		
<td colspan=16 class="titulo3">No hay Facturas en esta Fecha</td>	
</tr>
</table>
<?
		}
		else
		{
	?>
	<link HREF="../../public/stylesheets/impresiones.css"   rel="stylesheet" type="text/css">
<script language="JavaScript" type="text/javascript" src="../../public/javascripts/scripts.js"></script>
			<table class="tabla_citas"  cellpadding=0 cellspacing=0>
<tr>
<td colspan=1 class="logo">
<img src="../../public/images/head.png">
</td>
<td colspan=2 class="titulo">

</td>
<td colspan=1 class="titulo">

</td>
</tr>
<tr>
<td colspan=1 class="titulo2">
Rif: J-31180863-9
</td>
<td colspan=2 class="titulo">

</td>
<td colspan=1 class="titulo1">
</td>
</tr>
			
			<tr>		
<td colspan=16 class="titulo3">Comprobante de Retenci&oacute;n I.S.L.R</td>	
</tr>
<tr>
<td colspan=16 class="tdtitulos"><hr></hr></td>
</tr>
	
	<tr>
		<td colspan=1 class="factura">Fecha </td>
		<td colspan=1 class="datos_cliente"><?php echo $f_banco[fecha_imp_che] ?></td>
		<td colspan=1 class="factura">Banco</td>
		<td colspan=3 class="datos_cliente"><?php if ($banco<>13 ) { echo $f_banco[nombanco]; }?></td>
		<td colspan=1 class="factura">Cheque</td>
		<td colspan=1 class="datos_cliente"><?php if ($banco<>13 ) { echo $f_banco[numero_cheque];}?></td>
		<td colspan=3 class="factura">Nro. de Comprobante</td>
		<td colspan=1 class="datos_cliente"><?php echo $compro_retiva_islr?></td>
		<td colspan=3 class="factura">Codigo de Retencion</td>
		<td colspan=1 class="datos_cliente"><?php echo $f_proveedor[codigo]?></td>
	</tr>
	

	<tr>		
<td colspan=16 class="titulo3"><hr></hr></td>	
</tr>
	<tr>		
<td colspan=16 class="titulo3">Datos del Agente de Retenci&oacute;n</td>	
</tr>
	<tr>
		<td colspan=2 class="factura">Nombre o Raz&oacute;n Social </td>
		<td colspan=12 class="tdcampos">CLINISALUD MEDICINA PREPAGADA S.A.</td>
		<td colspan=1 class="factura">Rif </td>
		<td colspan=1 class="tdcampos">J-31180863-9</td>
		
	</tr>
	<tr>
		<td colspan=2 class="factura">Domicilio Fiscal </td>
		<td colspan=14 class="tdcampos">Av. las Americas C.C. Mayeya nivel Mezanina Locales 16,17 y 24 Sector Los Sauzales M&eacute;rida, estado M&eacute;rida</td>
		
	</tr>
	<tr>		
<td colspan=16 class="titulo3"><hr></hr></td>	
</tr>
	<tr>		
<td colspan=16 class="titulo3">Datos Del Proveedor</td>	
</tr>
	<tr>
		<td colspan=2 class="factura">Nombre o Raz&oacute;n Social </td>
		<td colspan=12 class="tdcampos"><?php echo $nombrepro?></td>
		<td colspan=1 class="factura">Rif </td>
		<td colspan=1 class="tdcampos"><?php echo $rifpro?></td>
		
	</tr>
	<tr>
		<td colspan=2 class="factura">Domicilio Fiscal  </td>
		<td colspan=12 class="tdcampos"><?php echo  $direccionpro?></td>
		<td colspan=1 class="factura">Telefono  </td>
		<td colspan=1 class="tdcampos"><?php echo  $telefonospro?></td>
	</tr>
	
	
	<tr>
		<td colspan=16 class="tdtitulos"><hr></hr></td>
		
	</tr>
	</table>
	<table class="tabla_citas"  border=1 cellpadding=0 cellspacing=0>
	<tr>		
<td colspan=16 class="titulo3">Datos De las Facturas</td>	
</tr>
		<tr>
		<td colspan=1 class="factura">Num </td>
		<td colspan=1 class="factura">Proceso</td>
		<td colspan=1 class="factura">Cedula</td>
		<td colspan=3 class="factura">Titular</td>
		<td colspan=3 class="factura">Paciente</td>
		<td colspan=1 class="factura">Cedula</td>
		<td colspan=1 class="factura">Gastos Clinicos</td>
		<td colspan=2 class="factura">Honorarios Profesionales</td>
		 <td colspan=1 class="factura">Total</td>
		 <td colspan=1 class="factura">Num Factura</td>
		 <td colspan=1 class="factura">Num Control</td>
	</tr>

<?php 
while($f_facturas=asignar_a($r_facturas,NULL,PGSQL_ASSOC)){
       if ($f_facturas[id_banco]==9){
        
        $sustraendo=0;
        }
	$totalgc=$totalgc +$f_facturas[monto_sin_retencion];
	$totalhm=$totalhm + $f_facturas[monto_con_retencion];
	$total_ret=	$total_ret + $f_facturas[retencion];
	/* **** Busco al Cliente**** */
	$q_titular="select procesos.id_beneficiario,clientes.* from clientes,titulares,procesos where clientes.id_cliente=titulares.id_cliente and titulares.id_titular=procesos.id_titular and procesos.id_proceso=$f_facturas[id_proceso]";
$r_titular=ejecutar($q_titular);
$f_titular=asignar_a($r_titular);

if ($f_titular[id_beneficiario>0])
{
		$q_bene="select * from clientes,beneficiarios where clientes.id_cliente=beneficiarios.id_cliente and beneficiarios.id_beneficiario=$f_titular[id_beneficiario]";
$r_bene=ejecutar($q_bene);
$f_bene=asignar_a($r_bene);
	$paciente="$f_bene[nombres] $f_bene[apellidos]";
	$ci=$f_bene[cedula];
	}
	else
	{
		$paciente="$f_titular[nombres] $f_titular[apellidos]";
	$ci=$f_titular[cedula];
		}
	/* **** Fin de Buscar al Cliente**** */
	$i++;
	$total_iva_ret= 	$total_iva_ret + $f_facturas[iva_retenido];
	$total_neto=$total_neto +  (($f_facturas[monto_sin_retencion] + $f_facturas[monto_con_retencion] + $f_facturas[iva]) - $f_facturas[iva_retenido]);
	$fecha_emision
	?>
	<tr>
		<td colspan=1 class="datos_cliente"><?php echo $i?></td>
		<td colspan=1 class="datos_cliente"><?php echo $f_facturas[id_proceso]?></td>
		<td colspan=1 class="datos_cliente"><?php echo $f_titular[cedula] ?></td>
		<td colspan=3 class="datos_cliente"><?php echo "$f_titular[nombres] $f_titular[apellidos]"?></td>
		<td colspan=3 class="datos_cliente"><?php echo $paciente?></td>
		<td colspan=1 class="datos_cliente"><?php echo $ci?></td>
		<td colspan=1 class="datos_cliente"><?php echo montos_print($f_facturas[monto_sin_retencion])?></td>
		<td colspan=2 class="datos_cliente"><?php echo montos_print($f_facturas[monto_con_retencion])?></td>
		<td colspan=1 class="datos_cliente"><?php echo montos_print(($f_facturas[monto_sin_retencion] + $f_facturas[monto_con_retencion] )) ?></td>
		<td colspan=1 class="datos_cliente"><?php echo $f_facturas[factura]?></td>
		<td colspan=1 class="datos_cliente"><?php echo $f_facturas[no_control_fact] ?></td>
	</tr>
	
	<?php
	}
	$total_rett= $total_ret -  $sustraendo;
?>
		<tr>
		<td colspan=9 class="tdtitulos"></td>
		
		<td colspan=1 class="factura">Total</td>
		<td colspan=1 class="factura"><?php echo montos_print($totalgc)?></td>
		<td colspan=2 class="factura"><?php echo montos_print($totalhm)?></td>
		<td colspan=1 class="factura"><?php echo montos_print($totalhm + $totalgc)?></td>
		<td colspan=1 class="tdtitulos"></td>
	</tr>
	
<tr>
<td colspan=7 class="factura">
Total Gastos Clinicos (a)</td>

<td colspan=2 class="tdtitulos"><?php echo montos_print($totalgc)?></td>
<td colspan=7 class="tdtitulos"></td>
</tr>
<tr>
<td colspan=7 class="factura">Total Gastos Honorarios Medicos (b)</td>

<td colspan=2 class="tdtitulos"><?php echo montos_print($totalhm)?></td>
<td colspan=7 class="tdtitulos"></td>
</tr>
<tr>
<td colspan=5 class="tdtitulos">
</td>
<td colspan=2 class="factura">
Total Gastos</td>
<td colspan=1 class="tdtitulos"><?php echo montos_print($totalhm + $totalgc)?></td>
<td colspan=8 class="tdtitulos"></td>
</tr>
<tr>
<td colspan=5 class="tdtitulos">
</td>
<td colspan=2 class="factura">
Total Descuento</td>
<td colspan=1 class="tdtitulos"><?php echo montos_print(0)?></td>
<td colspan=8 class="tdtitulos"></td>
</tr>
<tr>
<td colspan=5 class="tdtitulos">
</td>
<td colspan=2 class="factura">
Sub Total</td>
<td colspan=1 class="tdtitulos"><?php echo montos_print($totalhm + $totalgc)?></td>
<td colspan=8 class="tdtitulos"></td>
</tr>
<tr>
<td colspan=5 class="tdtitulos">
</td>
<td colspan=2 class="factura">
Total I.S.L.R <?php echo ($f_proveedor[porcentaje] * 100 ) ?> % sobre (a)</td>
<td colspan=1 class="tdtitulos"><?php echo montos_print($total_rett)?></td>
<td colspan=8 class="tdtitulos"></td>
</tr>
<tr>
<td colspan=7 class="factura">Monto Neto a Pagar </td>
<td colspan=2 class="tdtitulos"><?php echo montos_print(($totalhm + $totalgc) - $total_rett )?></td>
<td colspan=7 class="tdtitulos"></td>
</tr>
</table>
	<table class="tabla_citas"   cellpadding=0 cellspacing=0>

<tr>
<td colspan=16 class="tdtitulos"><hr></hr></td>
</tr>
<tr>
<td colspan=16 class="tdtitulos"><br></br></td>
			
</tr>
<tr>
<td colspan=5 class="titulo3">_______________________</td>
<td colspan=5 class="titulo3">_______________________</td>
<td colspan=6 class="titulo3">_______________________</td>
		
</tr>
<tr>
<td colspan=5 class="titulo3">Firma del Agente Retencion</td>
<td colspan=5 class="titulo3">Fecha Recibido</td>
<td colspan=6 class="titulo3">Firma del Sujeto Retenido</td>
		
</tr>
</table>
<?php
}
?>


