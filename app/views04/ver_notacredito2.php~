<?php
include ("../../lib/jfunciones.php");
sesion();
header('Content-Type: text/xml; charset=ISO-8859-1');
$factura = $_REQUEST['factura'];
$admin= $_SESSION['id_usuario_'.empresa];
$q_sucursales=("select * from sucursales  order by sucursales.sucursal");
$r_sucursales=ejecutar($q_sucursales);
$q_servicios=("select * from servicios  order by servicios.servicio");
$r_servicios=ejecutar($q_servicios);
$q_admin=("select * from admin  where admin.id_admin=$admin");
$r_admin=ejecutar($q_admin);
$f_admin=asignar_a($r_admin);
//busco las series.

$q_factura="select 
							tbl_series.*,
							tbl_facturas.*,
							tbl_notacredito.* 
					from 
							tbl_facturas,
							tbl_series,
							admin,
							tbl_notacredito 
					where 
							tbl_facturas.id_factura=tbl_notacredito.id_factura and 
							tbl_notacredito.num_notacredito='$factura' and 
							tbl_facturas.id_serie=tbl_series.id_serie and 
							tbl_series.id_sucursal=$f_admin[id_sucursal]  ;";
$r_factura=ejecutar($q_factura);

	if(num_filas($r_factura)==0){
		?>
		<table class="tabla_cabecera5"  cellpadding=0 cellspacing=0>
<tr>
<td  colspan=4  class="titulo_seccion">La factura No Existe</td> 
</tr>
</table>
	<?php
	}
	else
	{
			$f_factura = asignar_a($r_factura);
			$q_proceso="select * from procesos,tbl_procesos_claves where procesos.id_proceso=tbl_procesos_claves.id_proceso and   tbl_procesos_claves.id_factura=$f_factura[id_factura]";
$r_proceso=ejecutar($q_proceso);
$f_proceso=asignar_a($r_proceso);
			$q_procesos="select * from tbl_procesos_claves where   tbl_procesos_claves.id_factura=$f_factura[id_factura]";
$r_procesos=ejecutar($q_procesos);
		
		if ($f_factura[con_ente]>0)
				{
				//busco los datos del ente
	$q_ente="select * from entes where entes.id_ente=$f_factura[con_ente]";
	$r_ente = ejecutar($q_ente);
	$f_ente = asignar_a($r_ente);
					?>
					<table class="tabla_cabecera5"  cellpadding=0 cellspacing=0>
<tr>
<td  colspan=4  class="titulo_seccion">Datos del Cliente</td> 
</tr>
					<tr>
<td class="tdtitulos">Nombre o raz&oacute;n social:</td>
<td class="tdcampos"><?= $f_ente['nombre'] ?></td>
<td class="tdtitulos">Rif o C.I. No.: </td>
<td class="tdcampos"><?= $f_ente['rif'] ?></td>
</tr>

<tr>
<td class="tdtitulos">Direcci&oacute;n:</td>
<td class="tdcampos"><?= $f_ente['direccion'] ?></td>
<td class="tdtitulos">Tel&eacute;fonos:</td>
<td class="tdcampos"><?= $f_ente['telefonos'] ?></td>
</tr>
					<?php
					}
					else
					{

	
	$id_titular = $f_proceso['id_titular'];
	$id_beneficiario = $f_proceso['id_beneficiario'];
	$proceso= $f_proceso['id_proceso'];
	$clave= $f_proceso['no_clave'];
	//busco los datos del ente
	$q_ente="select entes.* from entes, titulares 
			where 
			titulares.id_titular = '$id_titular' and 
			titulares.id_ente = entes.id_ente;";
	$r_ente = ejecutar($q_ente);
	$f_ente = asignar_a($r_ente);

	//Busco los datos del titular.
	$q_titular = "select clientes.* from clientes, titulares 
			where 
			clientes.id_cliente = titulares.id_cliente and
			titulares.id_titular='$id_titular'";
	$r_titular = ejecutar($q_titular);
	$f_titular = asignar_a($r_titular);
    
$f_titular[id_cliente];
	//Busco los datos del beneficiario.
	if($id_beneficiario>0){
	$q_bene = "select clientes.* from clientes, titulares, beneficiarios
			where
			clientes.id_cliente = beneficiarios.id_cliente and
			titulares.id_titular = '$id_titular' and
			beneficiarios.id_titular = titulares.id_titular and
			beneficiarios.id_beneficiario = '$id_beneficiario'";
	$r_bene = ejecutar($q_bene);
	$f_bene = asignar_a($r_bene);
	}
	
	
?>

<table class="tabla_cabecera5"  cellpadding=0 cellspacing=0>
<tr>
<td  colspan=4  class="titulo_seccion">Datos del Cliente</td> 
</tr>

<?php
if($f_ente['id_ente']!=0){
?>
<tr>
<td class="tdtitulos">Nombre o raz&oacute;n social:</td>
<td class="tdcampos"><?= $f_ente['nombre'] ?></td>
<td class="tdtitulos">Rif o C.I. No.: </td>
<td class="tdcampos"><?= $f_ente['rif'] ?></td>
</tr>

<tr>
<td class="tdtitulos">Direcci&oacute;n:</td>
<td class="tdcampos"><?= $f_ente['direccion'] ?></td>
<td class="tdtitulos">Tel&eacute;fonos:</td>
<td class="tdcampos"><?= $f_ente['telefonos'] ?></td>
</tr>
<tr>
<td class="tdtitulos">Proceso</td>
<td class="tdcampos"><?php echo $proceso; ?></td>
<td class="tdtitulos">No. de Clave:</td>
<td class="tdcampos"><?= $clave ?></td>
</tr>
<tr>
<td class="tdtitulos">Titular: </td>
<td class="tdcampos"><?= $f_titular['nombres'].' '.$f_titular['apellidos'] ?></td>
<td class="tdtitulos">Cedula.</td>
<td class="tdcampos"><?= $f_titular['cedula'] ?></td>
</tr>
<?php
	if($id_beneficiario>0){
?>
	<tr>
	<td class="tdtitulos">Beneficiario: </td>
	<td class="tdcampos"><?= $f_bene['nombres'].' '.$f_bene['apellidos'] ?></td>
	<td class="tdtitulos">Cedula</td>
	<td class="tdcampos"><?= $f_bene['cedula'] ?></td>
	</tr>
<?php
	}else{
?>
	<tr><td class="tdtitulos"><b></b>  <b></b></td></tr>
<?php
	}
}
else
{
    
?>
<tr>
<td class="tdtitulos">Nombre o raz&oacute;n social:</td>
<td class="tdcampos"><?= $f_titular['nombres'] .' '.$f_titular['apellidos'] ?></td>
<td class="tdtitulos">Rif o C.I. No.:</td>
<td class="tdcampos"><?= $f_titular['cedula'] ?></td>
</tr>
<tr>
<td class="tdtitulos">Direcci&oacute;n: </td>
<td class="tdcampos"><?= $f_titular['direccion_hab'] ?></td>
<td class="tdtitulos">Tel&eacute;fonos:</td>
<td class="tdcampos"><?= $f_titular['telefono_hab'].' /  '.$f_titular['celular'] ?></td>
</tr>
<tr><td class="tdtitulos"><hr></td></tr>

<?php
}
}
?>
<tr>
<td colspan=4 class="tdtitulos"><hr></td></tr>

<?php
	//Busco los procesos que estan afiliados a la clave.
	pg_result_seek($r_procesos,0);
	while($f_proceso = asignar_a($r_procesos)){
		$subtotal=0;
		?>
		<tr>
		<td class="tdcamposr" colspan=1 >PROCESO</td>
		<td class="tdcamposr" colspan=1 ><?php echo $f_proceso[id_proceso] ?></td>
		</tr>
	<tr>
	<td class="tdtitulos" colspan=2 >CONCEPTO O DESCRIPCION	</td>
	<td class="tdtitulos" colspan=2 >Bs.</td>
</tr>
		
		
		<?php
		$q_proceso = "select gastos_t_b.*, procesos.* from gastos_t_b,procesos 
				where 
				procesos.id_proceso='$f_proceso[id_proceso]' and
				procesos.id_proceso=gastos_t_b.id_proceso";
		$r_proceso = ejecutar($q_proceso);
		if(num_filas($r_proceso)>0){
		while($f = asignar_a($r_proceso)){
		$subtotal=$subtotal + $f[monto_aceptado];
		$total=$total + $f[monto_aceptado];
		echo "
		<tr>
		<td class=\"tdcampos\" colspan=2 >$f[descripcion] &nbsp;&nbsp; $f[nombre]</td>
		<td class=\"tdcampos\" colspan=1  valign=\"bottom\">$f[monto_pagado]</td>
		</tr>

		";
		}
			echo "
		<tr>
		<td class=\"tdtitulos\" colspan=1 ></td>
		<td class=\"tdtitulos\" colspan=1 >Sud Total</td>
		<td class=\"tdtitulos\" colspan=1  valign=\"bottom\">$subtotal</td>
		</tr>

		";
		}
	}

?>
<tr>
<td  class="tdtitulos"></td>
<td  class="tdcamposr">Total BF.</td>
<td colspan=2 class="tdcamposr"><?php echo $total?></td> 
</tr>
<tr><td colspan=4  class="titulo_seccion"> Datos de la Factura

		
<?php $url="'views04/inotacredito.php?id_factura=$f_factura[id_factura]&num_notacredito=$factura','700','500'";
			?> <a href="javascript: imprimir(<?php echo $url; ?>);" class="boton" title="Imprimir Notas de Creditos"> Imprimir Nota Credito <?php echo "$num_notacredito" ?></a>
<?php $url="'views04/inotacreditogob.php?id_factura=$f_factura[id_factura]&num_notacredito=$factura','700','500'";
			?> <a href="javascript: imprimir(<?php echo $url; ?>);" class="boton" title="Imprimir Notas de Creditos"> Imprimir Nota Credito Plan Salud<?php echo "$num_notacredito" ?></a>

</td> 

	</tr>


</td> 
</tr>
<tr>
<td  class="tdtitulos">No. de Nota Credito</td>
<td  class="tdcampos"><input type="hidden" id="id_notacredito" name="id_notacredito" value="<?php echo $f_factura[id_notacredito]; ?>"><?php echo $f_factura[num_notacredito]; ?></td>
<td  class="tdtitulos">No. de Control Nota Credito</td>
<td  class="tdcampos"><input class="campos" size="10" type="text" id="controlfactura" name="controlfactura" value="<?php echo $f_factura[numcontrolnc]; ?>"></td>
<tr> 
<tr>
<td  class="tdtitulos">Afecta Factura</td>
<td  class="tdcampos"><?php echo $f_factura[numero_factura]; ?></td>
<td class="tdtitulos">Serie</td>
<td class="tdcampos"><input type="hidden" id="serie" name="serie" value="<?php echo $f_factura[id_serie]; ?>"><?php echo $f_factura[nomenclatura]; ?></td>
<tr> 
<tr> 
<td  class="tdtitulos">No. de Control Factura</td>
<td  class="tdcampos"><?php echo $f_factura[numcontrol]; ?></td>
</tr>
		<td  class="tdtitulos">* Fecha Emision   </td>
		<td>
 <input readonly type="text" size="10" id="dateField3" name="fechar" class="campos" maxlength="10" value="<?php echo $f_factura[fecha_emision]?>" > 
<a href="javascript:void(0);" onclick="g_Calendar.show(event, 'dateField3', 'yyyy-mm-dd')" title="Show popup calendar">
<img src="../public/images/calendar.gif" class="cp_img" alt="Seleccione la Fecha"></a>
                </td>
	<td class="tdtitulos"  colspan=1 align="left">Estado de Factura</td>
		<td class="titulos" colspan=1 align="left">
		
		
		<select id="estado_fac" name="estado_fac" class="campos" style="width: 200px;"  <?php echo $desactivar_2; ?>>
		
		<option value="0" <?php if($f_factura['edo_notacredito']==0) echo "selected"; ?>>Activa</option>
		<option value="1" <?php if($f_factura['edo_notacredito']==1) echo "selected"; ?>>Anulada</option>
	</select>
		</td>
		
	</tr>
	<tr>
	<td colspan=4 height=20 class="titulos"><hr></td>
	</tr>
	<tr>
			<td colspan=1 class="tdtitulos">Monto de la Nota Credito</td>
              	<td colspan=3 class="tdcampos"><?php echo $f_factura[montonc]?></td>
	</tr>
<tr>
			<td colspan=1 class="tdtitulos">Concepto</td>
              	<td colspan=3 class="tdcampos"><textarea id="concepto" name="concepto" cols=81 rows=2 class="campos"><?php echo $f_factura[concepto]?></textarea></td>
	</tr>	
<tr>
<tr>
<td class="tdtitulos"></td>
<td class="tdtitulos"></td>
<td class="tdtitulos"></td>
<td class="tdcampos"></td>
		</tr>
		
		<tr>		<td colspan=4 class="titulo_seccion">Buscar Factura</td>	</tr>	
	<tr>
		<td class="tdtitulos">* Numero de Factura</td>
		<td class="tdcampos"><input class="campos" type="text" id="facturanueva" name="facturanueva" maxlength=128 size=20 value=""     onkeypress="return event.keyCode!=13"></td>
		<td class="tdtitulos"></td>
		<td class="tdcampos"><input class="campos" type="hidden" name="vacio" maxlength=128 size=20 value=""><a href="#" OnClick="buscarfacturanc();" class="boton">Buscar</a><a href="#" OnClick="ir_principal();" class="boton">Salir</a></td>
		 
		</tr>
	</table>
<div id="buscarfacturanc"></div>

<?php }?>
