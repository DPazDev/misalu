<?php
 include ("../../lib/jfunciones.php");
 sesion();
 $eltitu=$_REQUEST['idtitular'];
 $tipclie=$_REQUEST['vetp'];

 if ($tipclie=='Titular'){
 $datipo='Titular';
  $querycobtti=("select clientes.nombres,clientes.apellidos,entes.nombre 
                      from
                          titulares,clientes,entes
                     where 
                        titulares.id_cliente=clientes.id_cliente and
		                titulares.id_ente=entes.id_ente and
		                titulares.id_titular=$eltitu;");
      $respcobtti=ejecutar($querycobtti);
      $dacobtti=assoc_a($respcobtti);
      $posid=$eltitu;
     $querytiycober=("select coberturas_t_b.id_cobertura_t_b,coberturas_t_b.id_propiedad_poliza,
                                            coberturas_t_b.monto_actual,propiedades_poliza.cualidad
                                            from 
                                            propiedades_poliza,coberturas_t_b
                                            where
				            coberturas_t_b.id_titular=$eltitu and
				            coberturas_t_b.id_propiedad_poliza=propiedades_poliza.id_propiedad_poliza 
				            and coberturas_t_b.id_organo<=1 and coberturas_t_b.id_beneficiario=0 order by propiedades_poliza.cualidad;");

/*************/
$q_cobertura="select * from entes,titulares,coberturas_t_b,gastos_t_b where 
 entes.id_ente=titulares.id_ente and
titulares.id_titular=coberturas_t_b.id_titular and
coberturas_t_b.id_cobertura_t_b=gastos_t_b.id_cobertura_t_b and 
coberturas_t_b.id_titular=$eltitu and coberturas_t_b.id_beneficiario=0"; 
$r_cobertura=ejecutar($q_cobertura);
$num_filas=num_filas($r_cobertura);

if ($num_filas == 0) {

$id_cobertura=0;
}
else
{

	$f_cobertura=asignar_a($r_cobertura);

if ($f_cobertura[id_beneficiario]==0){
$fechainicio="$f_cobertura[fecha_inicio_contrato]";
$fechafinal="$f_cobertura[fecha_renovacion_contrato]";

}
else
{
$fechainicio="$f_cobertura[fecha_inicio_contratob]";
$fechafinal="$f_cobertura[fecha_renovacion_contratob]";
}
}

/*************/
     
    $q_actualizar="select gastos_t_b.id_cobertura_t_b,count(coberturas_t_b.id_cobertura_t_b) from 
coberturas_t_b,gastos_t_b where 
coberturas_t_b.id_cobertura_t_b=gastos_t_b.id_cobertura_t_b and 
coberturas_t_b.id_titular=$eltitu  group by gastos_t_b.id_cobertura_t_b";


 /* **** Actualizo la cobertura**** */
$r_actualizar=ejecutar($q_actualizar);
while($f_actualizar=asignar_a($r_actualizar,NULL,PGSQL_ASSOC)){

$monto_actua=0;
$monto_gastos=0;
$q_propiedad="select * from propiedades_poliza,coberturas_t_b
where propiedades_poliza.id_propiedad_poliza=coberturas_t_b.id_propiedad_poliza and
coberturas_t_b.id_cobertura_t_b=$f_actualizar[id_cobertura_t_b]";
$r_propiedad=ejecutar($q_propiedad);
$f_propiedad=asignar_a($r_propiedad);

$q_cgastos="select * from gastos_t_b,procesos where
gastos_t_b.id_proceso=procesos.id_proceso and procesos.gasto_viejo='0' and
procesos.fecha_recibido>='$fechainicio' and procesos.fecha_recibido<='$fechafinal' and
gastos_t_b.id_cobertura_t_b=$f_actualizar[id_cobertura_t_b]"; 
$r_cgastos=ejecutar($q_cgastos);
while($f_cgastos=asignar_a($r_cgastos,NULL,PGSQL_ASSOC)){
$monto_gastos= $monto_gastos +
$f_cgastos[monto_aceptado];
}

if ($f_cobertura[id_beneficiario]==0) 
{
	$monto_actual= $f_propiedad[monto_nuevo] - $monto_gastos;
	
	}
else
{
	
$monto_actual= $f_propiedad[monto] - $monto_gastos;

}
$mod_cobertura="update coberturas_t_b set monto_actual='$monto_actual' where
coberturas_t_b.id_cobertura_t_b='$f_actualizar[id_cobertura_t_b]' and
coberturas_t_b.id_titular='$f_cobertura[id_titular]' and
coberturas_t_b.id_beneficiario='$f_cobertura[id_beneficiario]'";
$fmod_cobertura=ejecutar($mod_cobertura);



}
/* **** Fin de Actualizar la cobertura**** */
$resultiyco=ejecutar($querytiycober);
 }else{
 $datipo='Beneficiario(a)';
 $querycobtti=("select clientes.nombres,clientes.apellidos,entes.nombre 
from
  clientes,beneficiarios,titulares,entes
               where 
                beneficiarios.id_cliente=clientes.id_cliente and
	        titulares.id_ente=entes.id_ente and
		beneficiarios.id_titular=titulares.id_titular and 
		beneficiarios.id_beneficiario=$eltitu;");
 $respcobtti=ejecutar($querycobtti);
 $dacobtti=assoc_a($respcobtti);
 $posid=$eltitu;
 $querytiycober=("select coberturas_t_b.id_cobertura_t_b,coberturas_t_b.id_propiedad_poliza,
                                            coberturas_t_b.monto_actual,propiedades_poliza.cualidad
                                            from 
                                            propiedades_poliza,coberturas_t_b
                                            where
				            coberturas_t_b.id_beneficiario=$eltitu and
				            coberturas_t_b.id_propiedad_poliza=propiedades_poliza.id_propiedad_poliza 
				            and coberturas_t_b.id_organo<=1 order by propiedades_poliza.cualidad;");
							
							
			/*************/
$q_cobertura="select * from entes,titulares,coberturas_t_b,gastos_t_b where 
 entes.id_ente=titulares.id_ente and
titulares.id_titular=coberturas_t_b.id_titular and
coberturas_t_b.id_cobertura_t_b=gastos_t_b.id_cobertura_t_b and coberturas_t_b.id_beneficiario=$eltitu"; 
$r_cobertura=ejecutar($q_cobertura);
$num_filas=num_filas($r_cobertura);

if ($num_filas == 0) {

$id_cobertura=0;
}
else
{

	$f_cobertura=asignar_a($r_cobertura);

if ($f_cobertura[id_beneficiario]==0){
$fechainicio="$f_cobertura[fecha_inicio_contrato]";
$fechafinal="$f_cobertura[fecha_renovacion_contrato]";

}
else
{
$fechainicio="$f_cobertura[fecha_inicio_contratob]";
$fechafinal="$f_cobertura[fecha_renovacion_contratob]";
}
}
/*************/
     
    $q_actualizar="select gastos_t_b.id_cobertura_t_b,count(coberturas_t_b.id_cobertura_t_b) from coberturas_t_b,gastos_t_b where coberturas_t_b.id_cobertura_t_b=gastos_t_b.id_cobertura_t_b and coberturas_t_b.id_beneficiario=$eltitu  group by gastos_t_b.id_cobertura_t_b";


 /* **** Actualizo la cobertura**** */
$r_actualizar=ejecutar($q_actualizar);
while($f_actualizar=asignar_a($r_actualizar,NULL,PGSQL_ASSOC)){

$monto_actua=0;
$monto_gastos=0;
$q_propiedad="select * from propiedades_poliza,coberturas_t_b
where propiedades_poliza.id_propiedad_poliza=coberturas_t_b.id_propiedad_poliza and
coberturas_t_b.id_cobertura_t_b=$f_actualizar[id_cobertura_t_b]";
$r_propiedad=ejecutar($q_propiedad);
$f_propiedad=asignar_a($r_propiedad);

$q_cgastos="select * from gastos_t_b,procesos where
gastos_t_b.id_proceso=procesos.id_proceso and procesos.gasto_viejo='0' and
procesos.fecha_recibido>='$fechainicio' and procesos.fecha_recibido<='$fechafinal' and
gastos_t_b.id_cobertura_t_b=$f_actualizar[id_cobertura_t_b]"; 
$r_cgastos=ejecutar($q_cgastos);
while($f_cgastos=asignar_a($r_cgastos,NULL,PGSQL_ASSOC)){
$monto_gastos= $monto_gastos +
$f_cgastos[monto_aceptado];
}

if ($f_cobertura[id_beneficiario]==0) 
{
	$monto_actual= $f_propiedad[monto_nuevo] - $monto_gastos;
	
	}
else
{
	
$monto_actual= $f_propiedad[monto] - $monto_gastos;

}
$mod_cobertura="update coberturas_t_b set monto_actual='$monto_actual' where
coberturas_t_b.id_cobertura_t_b='$f_actualizar[id_cobertura_t_b]' and
coberturas_t_b.id_titular='$f_cobertura[id_titular]' and
coberturas_t_b.id_beneficiario='$f_cobertura[id_beneficiario]'";
$fmod_cobertura=ejecutar($mod_cobertura);



}
/* **** Fin de Actualizar la cobertura**** */				
							
							
							
							
 $resultiyco=ejecutar($querytiycober);   
 }
 echo"<br>";
 echo"<table class=\"tabla_cabecera3\" cellpadding=0 cellspacing=0>
       <tr>
	  <td colspan=4 class=\"titulo_seccion\">La cobertura del(a) $datipo $dacobtti[nombres] $dacobtti[apellidos] del ente $dacobtti[nombre] ($posid)</td>
       </tr>
     </table>
     <table class=\"tabla_citas\"  cellpadding=0 cellspacing=0>
          <TR>
	     <TH>Poliza</TH>
	     <TH>Monto</TH>
	 </TR> ";
        while ($datyco=asignar_a($resultiyco)){
	        if ($datyco['id_organo']<>0){
		  $queryorga=("select organo from organos where id_organo=$datyco[id_organo]");
		  $resorga=ejecutar($queryorga);
		  $norga=assoc_a($resorga);
		  $orgaes=$norga['organo'];		  
		}    
	   echo"<tr>
	          <td class=\"tdcampos\">$datyco[cualidad] $orgaes</td>
		  <td class=\"tdcampos\">$datyco[monto_actual]</td>
	       </tr>";	
	       $orgaes="";
	}	 
 echo"</table>";	
?>
